<!-- Relies on HTML elements and IDs declared in `publication.html` and `publications.md` !-->
<div id="searchBar" class="container-fluid border border-dark rounded">
    <form class="form-inline m-2 p-1">
        <label class="mr-2" for="searchField">Search Field</label>
        <select id="searchField" class="custom-select m-1 mr-2">
            <option selected value="title">Title</option>
            <option value="source">Publication Source</option>
            <option value="author">Author</option>
            <option value="primary-author">Primary Author</option>
        </select>
        <input id="searchText" type="text" class="form-control m-1 mr-2" placeholder="Search Text">
        <button id="searchSubmit" type="submit" class="btn btn-outline-dark m-1 mr-2">Search</button>
        <button id="searchAdvanced" class="btn btn-dark m-1 mr-4" onclick="$('#searchOptions').toggle()">Options</button>
        <p id="search-matched" class="text-muted m-1 my-1"></p>
    </form>
    <form id="searchOptions" class="form-inline bg-dark m-2 p-2 rounded" style="display: none;">
        <div class="form-check form-check-inline mr-4">
            <input id="searchOptionCaseInsensitive" class="form-check-input" type="checkbox" value="yes">
            <label class="form-check-label text-light" for="searchOptionCaseInsensitive">Case-Insensitive</label>
        </div>
        <div class="form-check form-check-inline">
            <input id="searchOptionRegex" class="form-check-input" type="checkbox" value="yes">
            <label class="form-check-label text-light" for="searchOptionRegex">Regex</label>
        </div>
    </form>
</div>
<script>
    // Publication values

    // Array of publications
    var publications = [];

    // State of publication IDs (loaded or not loaded)
    var publicationsLoaded = false;

    // Utility functions

    // Parses a URL string representation of a search query and returns its object
    function decodeHash(str) {
        const SEARCH_FIELDS = $('#searchField option').map(function () {
            return $(this).val();
        }).get();

        var result = {
            searchField: DEFAULT_SEARCH_FIELD,
            searchText: DEFAULT_SEARCH_TEXT
        };

        const index = str.indexOf(SEARCH_QUERY_PREFIX);
        if (index !== 0)
            return result;

        const queryComponents = str.substring(SEARCH_QUERY_PREFIX.length).split('&') || [];

        for (var i = 0; i < queryComponents.length; i++) {
            const componentKeyValue = queryComponents[i].split('=');
            const componentKey = componentKeyValue[0] || '';
            const componentValue = decodeURIComponent(componentKeyValue[1]) || '';

            if (componentKey === 'field') {
                result.searchField = componentValue;
            } else {
                const index = SEARCH_FIELDS.indexOf(componentKey);
                if (index === -1)
                    return result;
                else if (SEARCH_FIELDS[index] === 'text')
                    result.searchText = componentValue;
            }
        }

        return result;
    }

    // Converts the search query object into its URL string representation
    function encodeHash(obj) {
        return '#search#field=' + encodeURIComponent(obj.searchField || DEFAULT_SEARCH_FIELD) + '&text=' +
            encodeURIComponent(obj.searchText || DEFAULT_SEARCH_TEXT);
    }

    // Resets the HTML of the given reference
    function resetReference(id) {
        const pub = publications[id];

        // Reset title
        // Uses the same format as in `reference.html`
        $('#' + pub.key + '-title').html(pub.title + ' (' + pub.author_0_last + ' et al. ' + pub.year + ')');

        // Enable element
        $('#' + pub.key).show();
    }

    // Set default values on page load

    const DEFAULT_SEARCH_TEXT = '';
    const DEFAULT_SEARCH_FIELD = 'title';
    const SEARCH_QUERY_PREFIX = '#search#';
    const SEARCH_EARLIEST_YEAR = 2001;
    const SEARCH_LATEST_YEAR = 2020;
    const initialQuery = window.location.hash.indexOf(SEARCH_QUERY_PREFIX) === 0 ? decodeHash(window.location.hash) : {
        searchField: DEFAULT_SEARCH_FIELD,
        searchText: DEFAULT_SEARCH_TEXT
    };

    $('#searchField').val(initialQuery.searchField);
    $('#searchText').val(initialQuery.searchText);

    // Handle form update on submit
    $('#searchSubmit').click(function () {
        // Create search object
        const obj = {
            searchField: $('#searchField').val() || 'title',
            searchText: $('#searchText').val() || ''
        };

        // Set window hash
        window.location.hash = encodeHash(obj);

        // Toggle visibility of "No Publications" messages
        $('#highlighted-empty').hide();
        $('#full-empty').hide();

        // Toggle visibility of all sections
        $('#highlighted').hide();
        for (var i = SEARCH_EARLIEST_YEAR; i <= SEARCH_LATEST_YEAR; i++)
            $('#year-' + i).hide();
        $('#previous').hide();

        // Record matches
        var matched = 0;

        // Search for value
        for (var i = 0; i < publications.length; i++) {
            const pub = publications[i];
            var parent = $('#' + pub.key);
            resetReference(i);

            // Search by title
            if (obj.searchField === 'title') {
                var el = $('#' + pub.key + '-title');
                const val = el.html();
                const exists = pub.title.indexOf(obj
                    .searchText) !== -1;

                // Toggle parent element
                parent.toggle(exists);

                // Edit page if the item is a match
                if (exists) {
                    // Highlight matches in title
                    const res = val.replace(obj.searchText, '<span style="background-color: yellow">' + obj
                        .searchText + '</span>');
                    el.html(res);

                    // Enable parent section
                    const year = Number(pub.year);
                    if (pub.highlighted === "true")
                        $('#highlighted').show();
                    else if (year > SEARCH_EARLIEST_YEAR)
                        $('#year-' + year).show();
                    else if (year <= SEARCH_EARLIEST_YEAR)
                        $('#previous').show();

                    // Record match
                    matched++;
                }
            }
            // Search by author
            else if (obj.searchField === 'author') {

            }
        }

        // Enable "No Publications" message if no matches were found
        if ($('#highlighted').is(':hidden'))
            $('#highlighted-empty').show();
        var hidden = true;
        for (var i = SEARCH_EARLIEST_YEAR; i <= SEARCH_LATEST_YEAR; i++)
            hidden = hidden && $('#year-' + i).is(':hidden');
        if (hidden && $('#previous').is(':hidden'))
            $('#full-empty').show();

        // Set matched text
        var matchedText = '';
        if (matched <= 0)
            matchedText = 'No matches were found'
        else if (matched < publications.length)
            matchedText = 'Matched ' + matched + ' out of ' + publications.length + ' publications';
        else
            matchedText = 'Matched all (' + publications.length + ') publications'
        $('#search-matched').html(matchedText);
    });

    // Trigger search on page load
    $(document).ready(function () {
        $('#searchSubmit').trigger('click');
    });
</script>